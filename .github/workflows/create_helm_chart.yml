name: Release Helm Charts

on:
  push:
    branches:
      - main
      - v2
  workflow_dispatch:

jobs:
  release:
    runs-on: helm-chart-builder
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install chart-releaser
        uses: helm/chart-releaser-action@v1.5.0
        with:
          install_only: true
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

      - name: Publish common chart
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        run: |
          owner="${GITHUB_REPOSITORY%%/*}"
          repo="${GITHUB_REPOSITORY##*/}"

          cr package charts/common --package-path .cr-release-packages
          cr upload --owner "$owner" --git-repo "$repo" --package-path .cr-release-packages --skip-existing

      - name: Publish remaining charts
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        run: |
          owner="${GITHUB_REPOSITORY%%/*}"
          repo="${GITHUB_REPOSITORY##*/}"

          for chart_dir in charts/*; do
            chart_name="$(basename "$chart_dir")"
            if [ "$chart_name" = "common" ]; then
              continue
            fi
            if [ -f "$chart_dir/Chart.yaml" ]; then
              cr package "$chart_dir" --package-path .cr-release-packages
            fi
          done
          cr upload --owner "$owner" --git-repo "$repo" --package-path .cr-release-packages --skip-existing
          mkdir -p .cr-index
          cr index --owner "$owner" --git-repo "$repo" --package-path .cr-release-packages --push
