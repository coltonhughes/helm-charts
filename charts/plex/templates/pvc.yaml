{{- $existingClaim := .Values.persistence.existingClaim | default .Values.persistence.exisitingClaim }}
{{- if and .Values.persistence.enabled (not $existingClaim) }}
{{- $pvc := lookup "v1" "PersistentVolumeClaim" .Release.Namespace (include "plex.fullname" .) }}
{{- $storageClass := .Values.persistence.storageClass | default "" }}
{{- if and (eq $storageClass "") $pvc }}
{{- $storageClass = $pvc.spec.storageClassName | default "" }}
{{- end }}
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: {{ include "plex.fullname" . }}
  labels:
      {{- include "plex.labels" . | nindent 4 }}
spec:
  accessModes:
    - {{ .Values.persistence.accessMode | quote }}
  resources:
      requests:
          storage: {{ .Values.persistence.size | quote }}
  {{- if $storageClass }}
  storageClassName: {{ $storageClass | quote }}
  {{- end }}
  {{- if and $pvc $pvc.spec.volumeName }}
  volumeName: {{ $pvc.spec.volumeName | quote }}
  {{- end }}
{{- end }}
